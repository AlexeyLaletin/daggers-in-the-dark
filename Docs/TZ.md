# Техническое задание (ТЗ)
## Проект: интерактивная карта фракций для «Клинков во Тьме»

### 1) Цель
Создать приложение для мастера настольной ролевой игры «Клинки во Тьме», позволяющее:
- визуализировать состояние города и территорий фракций на карте;
- вести связанные заметки о фракциях, персонажах и местах (по модели связей как в Obsidian);
- переключаться между режимами «Мастер» и «Игроки» (скрывая часть информации);
- хранить историю изменений состояния города во времени (таймлайн со слайдером по датам);
- **графически изменять границы/территории фракций** путём рисования полупрозрачными цветами поверх карты.

### 2) Пользователи и сценарии
#### 2.1 Роль: Мастер
- Загружает базовую карту (изображение города).
- Создаёт и редактирует фракции (цвет, прозрачность, заметки).
- Рисует территорию фракции на карте (кисть/ластик), при необходимости скрывает слои.
- Ведёт заметки о персонажах и местах, связывает их между собой и с фракциями.
- Отмечает часть сведений как скрытые для игроков.
- Создаёт «снимки» состояния города на конкретную дату и переключается по таймлайну.
- Экспортирует/импортирует проект.

#### 2.2 Роль: Игроки (просмотр)
- Открывают режим «Игроки» и видят только разрешённую мастером информацию.
- Могут вести **свой** граф связей/заметок (player-graph) поверх публичных сущностей.

### 3) Область и границы (scope)
#### 3.1 Входит в MVP
- Карта: загрузка изображения, pan/zoom.
- Фракции: CRUD, цвет, прозрачность.
- Территории: рисование по карте полупрозрачным цветом фракции, хранение результата.
- Сущности: People/Places/Factions + заметки (public/GM).
- Связи: Obsidian-подобные wikilinks `[[...]]` в markdown + просмотр графа/бэклинков.
- Режим GM/Player: фильтрация скрытых данных.
- Таймлайн: снимки состояния по датам и переключение (Wayback-подобный UX).
- Экспорт/импорт проекта.

#### 3.2 Не входит в MVP (возможные будущие итерации)
- Онлайн-совместная работа (real-time).
- Полноценный векторный редактор границ (полигоны); в MVP — битмап-рисование.
- Сложная система прав доступа/аккаунтов.
- Автоматическая симуляция влияния/экономики фракций.

### 4) Архитектура (тонкий клиент)
#### 4.1 Общее описание
Приложение работает как **десктоп** через Electron, но архитектурно разделено на два компонента:
- **Backend (локальный сервер)**: управляет моделью данных, связями, таймлайном, экспортом/импортом и хранением.
- **Frontend (тонкий клиент)**: отвечает за визуализацию карты, UI-редакторы, рисование территорий и отображение графа.

Backend запускается локально (только `127.0.0.1`) и используется UI через HTTP API.

#### 4.2 Технологии (предпочтение)
- Backend: **Python + FastAPI + SQLite**.
- Frontend: **React + TypeScript** (сборка Vite).
- Desktop: **Electron** (упаковка единого приложения).

### 5) Данные и сущности
#### 5.1 Фракция (Faction)
- `id`
- `name`
- `color` (RGB/HEX)
- `opacity` (0..1)
- `notes_public` (markdown)
- `notes_gm` (markdown)

#### 5.2 Персонаж (Person)
Рекомендуемые поля:
- `id`, `name`, `aliases[]`
- `faction_memberships[]`: список (factionId, role/статус)
- `workplace_place_id?` (место работы)
- `home_place_id?` (дом/база)
- `status` (alive/dead/unknown/…)
- `tags[]`
- `notes_public`, `notes_gm` (markdown)

#### 5.3 Место (Place)
- `id`, `name`
- `type` (building/district/landmark/other)
- `position?` (опциональная метка/pin на карте: x,y в координатах карты)
- `owner_faction_id?` (опционально)
- `notes_public`, `notes_gm`

#### 5.4 Заметка/страница (NotePage)
Чтобы реализовать «как в Obsidian», отдельные страницы с заголовком и телом:
- `id`
- `title`
- `body_markdown`
- `visibility` (public/gm)
- `entity_ref?` (опциональная привязка к сущности)

#### 5.5 Связи (Links)
- Авто-ссылки: извлекаются из `[[wikilinks]]` в markdown.
- Ручные связи: (from, to, type, visibility, meta).

#### 5.6 Карта и территории
- Базовая карта: изображение (asset проекта).
- Территории: слой/маска на фракцию.
- Представление: **битмап-тайлы** (например 256x256) для хранения и частичного обновления.

### 6) Рисование территорий (ключевая функциональность)
#### 6.1 UX
- Выбор активной фракции (цвет).
- Инструменты: кисть, ластик, пипетка (опционально), настройка размера/жёсткости кисти.
- Слои: видимость по фракциям, общий ползунок прозрачности (на фракцию).

#### 6.2 Принцип хранения
- Фронтенд рисует на Canvas для отзывчивости.
- При изменениях фронтенд отправляет изменённые тайлы маски в backend.
- Backend хранит тайлы в SQLite (BLOB) с привязкой к `snapshot_id` и `faction_id`.

### 7) Таймлайн (история во времени)
- Снимок (`snapshot`) фиксирует состояние на дату (и/или метку).
- UI: слайдер дат + список снимков.
- Переключение снимка меняет:
  - отображение территорий,
  - данные/заметки/связи (если они изменялись по снимкам).

Примечание: в MVP допустимы **полные снимки**; оптимизация на дельты — позже.

### 8) Режимы GM/Player
- Переключатель режима в UI.
- На уровне API: backend фильтрует скрытые поля и сущности по `visibility`.
- В режиме Player скрывается всё, что помечено как GM-only.
- Дополнительно: отдельный «граф игроков» (player-graph) как самостоятельные заметки/связи, видимые только в Player-режиме.

### 9) API (высокоуровнево)
Минимальные группы эндпоинтов:
- `/api/factions` CRUD
- `/api/people` CRUD
- `/api/places` CRUD
- `/api/pages` CRUD (markdown pages)
- `/api/graph` (nodes/edges, backlinks, фильтры gm/player)
- `/api/snapshots` (list/create/select)
- `/api/snapshots/{id}/territory/tiles` (download/upload изменённых тайлов)
- `/api/export` / `/api/import`

### 10) Экспорт/импорт
Требования:
- Переносимость проекта между устройствами.
- В MVP: экспорт как файл проекта (варианты):
  - SQLite-файл проекта (предпочтительно),
  - либо zip-пакет (SQLite + assets) — если понадобится.

### 11) Нефункциональные требования
- **Производительность**: рисование не должно лагать на средних картах (ориентир: 4k), тайлинг и кэш.
- **Надёжность**: защита от порчи проекта (атомарные операции на запись снимков/тайлов).
- **Безопасность**: backend слушает только localhost; Electron и backend обмениваются токеном (в будущем).
- **Юзабилити**: быстрые hotkeys (позже), undo/redo (позже).

### 12) Критерии приёмки MVP
- Можно загрузить карту, создать ≥3 фракции и **закрасить** территории каждой полупрозрачным цветом, при этом карта остаётся видимой под заливкой.
- Можно создать персонажа и место, связать их (через поля и/или wikilinks), увидеть backlinks.
- Можно создать GM-only заметку и убедиться, что в Player-режиме она не отображается.
- Можно создать 2 снимка на разные даты, изменить территории, и при переключении снимков видеть разные состояния карты.
- Можно экспортировать проект и импортировать его в “чистую” установку, получив те же данные и слои.

