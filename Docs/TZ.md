# Техническое задание (ТЗ)
## Проект: интерактивная карта фракций для «Клинков во Тьме»

**Related documentation:**
- **[README.md](../README.md)** - Quick start, project overview
- **[SystemDesign.md](SystemDesign.md)** - Technical architecture, API contracts, data models
- **[AGENTS.md](../AGENTS.md)** - AI agent instructions for development

### 1) Цель
Создать приложение для мастера настольной ролевой игры «Клинки во Тьме», позволяющее:
- визуализировать состояние города и территорий фракций на карте;
- вести связанные заметки о фракциях, персонажах и местах (по модели связей как в Obsidian);
- переключаться между режимами «Мастер» и «Игроки» (скрывая часть информации);
- хранить историю изменений состояния города во времени (таймлайн со слайдером по датам);
- **графически изменять границы/территории фракций** путём рисования полупрозрачными цветами поверх карты.

### 2) Пользователи и сценарии
#### 2.1 Роль: Мастер
- Загружает базовую карту (изображение города).
- Создаёт и редактирует фракции (цвет, прозрачность, заметки).
- Рисует территорию фракции на карте (кисть/ластик), при необходимости скрывает слои.
- Ведёт заметки о персонажах и местах, связывает их между собой и с фракциями.
- Отмечает часть сведений как скрытые для игроков.
- Создаёт «снимки» состояния города на конкретную дату и переключается по таймлайну.
- Экспортирует/импортирует проект.

#### 2.2 Роль: Игроки (просмотр)
- Открывают режим «Игроки» и видят только разрешённую мастером информацию.
- Могут вести **свой** граф связей/заметок (player-graph) поверх публичных сущностей.

### 3) Область и границы (scope)
#### 3.1 Входит в MVP
- Карта: загрузка изображения, pan/zoom.
- Фракции: CRUD, цвет, прозрачность.
- Территории: рисование по карте полупрозрачным цветом фракции, хранение результата.
- Сущности: People/Places/Factions + заметки (public/GM).
- Связи: Obsidian-подобные wikilinks `[[...]]` в markdown + просмотр графа/бэклинков.
- Режим GM/Player: фильтрация скрытых данных.
- Таймлайн: снимки состояния по датам и переключение (Wayback-подобный UX).
- Экспорт/импорт проекта.

#### 3.2 Не входит в MVP (возможные будущие итерации)
- Онлайн-совместная работа (real-time).
- Полноценный векторный редактор границ (полигоны); в MVP — битмап-рисование.
- Сложная система прав доступа/аккаунтов.
- Автоматическая симуляция влияния/экономики фракций.

### 4) Архитектура (тонкий клиент)
#### 4.1 Общее описание
Приложение работает как **десктоп** через Electron, но архитектурно разделено на два компонента:
- **Backend (локальный сервер)**: управляет моделью данных, связями, таймлайном, экспортом/импортом и хранением.
- **Frontend (тонкий клиент)**: отвечает за визуализацию карты, UI-редакторы, рисование территорий и отображение графа.

Backend запускается локально (только `127.0.0.1`) и используется UI через HTTP API.

#### 4.2 Технологии (предпочтение)
- Backend: **Python + FastAPI + SQLite**.
- Frontend: **React + TypeScript** (сборка Vite).
- Desktop: **Electron** (упаковка единого приложения).

### 5) Данные и сущности
#### 5.1 Фракция (Faction)
- `id`
- `name`
- `color` (RGB/HEX)
- `opacity` (0..1)
- `notes_public` (markdown)
- `notes_gm` (markdown)

#### 5.2 Персонаж (Person)
Рекомендуемые поля:
- `id`, `name`, `aliases[]`
- `faction_memberships[]`: список (factionId, role/статус)
- `workplace_place_id?` (место работы)
- `home_place_id?` (дом/база)
- `status` (alive/dead/unknown/…)
- `tags[]`
- `notes_public`, `notes_gm` (markdown)

**Расширение**: для персонажей игроков (PC) существует связанная таблица `player_characters` с дополнительными полями (playbook, crew, is_active). См. раздел 5.9.

#### 5.3 Место (Place)
- `id`, `name`
- `type` (building/district/landmark/other)
- `position?` (опциональная метка/pin на карте: x,y в координатах карты)
- `owner_faction_id?` (опционально)
- `scope` (public|gm|player) — область видимости места
- `notes_public`, `notes_gm`

**MVP уточнение (POI)**: в MVP поддерживаются только **точечные маркеры** (Place с position x,y). Сложные области/полигоны откладываются на следующую итерацию. **Создание POI кликом**: и GM, и игроки могут создавать POI кликом по карте. POI, созданные игроками, по умолчанию имеют scope=public (игроки не могут создавать GM-only контент). В Player-режиме gm-места скрыты, игроки не могут редактировать scope или notes_gm полей.

#### 5.4 Заметка/страница (NotePage)
Чтобы реализовать «как в Obsidian», отдельные страницы с заголовком и телом:
- `id`
- `title`
- `body_markdown`
- `scope` (public|gm|player) — область видимости заметки
- `entity_ref?` (опциональная привязка к сущности)

**Scope (область видимости)**:
- `public` — видна всем (GM и игрокам)
- `gm` — видна только мастеру
- `player` — заметки игроков (общий граф для всех игроков, см. "Shared Player-Graph" ниже)

**Shared Player-Graph**: игроки могут вести свой граф заметок и связей (scope=player) поверх публичных сущностей. Это единый граф для всей группы игроков, без разделения по отдельным игрокам.

#### 5.5 Связи (Links)
- Авто-ссылки: извлекаются из `[[wikilinks]]` в markdown.
- Ручные связи: (from, to, type, scope, meta).

**Поле scope**: как и в NotePage, связи имеют scope (public|gm|player) для фильтрации в зависимости от режима просмотра.

#### 5.6 Карта и территории
- Базовая карта: изображение (asset проекта).
- Территории: слой/маска на фракцию.
- Представление: **битмап-тайлы** (например 256x256) для хранения и частичного обновления.

#### 5.7 Мир/Город (World)
Сущность "мир" представляет город/сеттинг проекта:
- `id`
- `name` — название города/мира
- `description` — описание (markdown)
- `timezone` — часовой пояс для корректной работы таймлайна
- `created_at`, `updated_at`

**Зачем**: в архитектуре "1 проект = 1 SQLite файл", все сущности (фракции, люди, места, события) привязаны к world_id. В MVP один мир на проект; в будущем возможно расширение до нескольких миров.

#### 5.8 События (Events)
События — это **лог/нарратив** изменений в мире. События не изменяют состояние данных напрямую, а служат для фиксации истории:
- `id`
- `world_id` (FK)
- `at_datetime` — когда произошло событие
- `title` — краткое название
- `body_markdown` — подробное описание (с wikilinks)
- `scope` (public|gm|player) — видимость события
- `snapshot_id` (nullable) — опциональная привязка к снимку состояния

**Связи событий с сущностями** (EventRef):
- `event_id` (FK)
- `entity_type` (faction|person|place|page)
- `entity_id` — ID сущности
- `role` — роль сущности в событии (involved, location, target и т.п.)

Примеры событий: "Бой в таверне Leaky Bucket", "Смерть босса Roric", "Рейд Bluecoats на склады".

#### 5.9 Персонажи игроков (Player Characters)
Персонажи игроков (PC) — это расширение сущности Person:
- Базовые данные хранятся в `people` (имя, алиасы, статус, принадлежность к фракциям)
- Дополнительная таблица `player_characters`:
  - `person_id` (PK, FK -> people.id)
  - `playbook` — архетип персонажа (Cutter, Lurk, Slide и т.д.)
  - `crew` — название команды игроков
  - `is_active` — активный ли персонаж

**Зачем**: не плодить отдельные таблицы для NPC и PC, а использовать единую модель Person с опциональным расширением.

### 6) Рисование территорий (ключевая функциональность)
#### 6.1 UX
- Выбор активной фракции (цвет).
- Инструменты: кисть, ластик, пипетка (опционально), настройка размера/жёсткости кисти.
- Слои: видимость по фракциям, общий ползунок прозрачности (на фракцию).

#### 6.2 Принцип хранения
- Фронтенд рисует на Canvas для отзывчивости.
- При изменениях фронтенд отправляет изменённые тайлы маски в backend.
- Backend хранит тайлы в SQLite (BLOB) с привязкой к `snapshot_id` и `faction_id`.

### 7) Таймлайн (история во времени)
- Снимок (`snapshot`) фиксирует состояние на дату (и/или метку).
- UI: слайдер дат + список снимков.
- Переключение снимка меняет:
  - отображение территорий,
  - данные/заметки/связи (если они изменялись по снимкам).

Примечание: в MVP допустимы **полные снимки**; оптимизация на дельты — позже.

### 8) Режимы GM/Player
- Переключатель режима в UI.
- На уровне API: backend фильтрует скрытые поля и сущности по полю `scope`:
  - **GM mode**: показывает всё (public + gm + player)
  - **Player mode**: показывает только public + player (gm-контент скрыт)
- Отдельный «граф игроков» (player-graph): заметки и связи с scope=player, видимые в Player-режиме. Это общий граф для всех игроков (shared), без разделения по отдельным игрокам.
- Поля `notes_gm` у сущностей (Faction, Person, Place) также фильтруются: в Player mode возвращается null/пустое значение.

### 9) API (высокоуровнево)
Минимальные группы эндпоинтов:
- `/api/project/init` — инициализация проекта (см. раздел 9.1)
- `/api/factions` CRUD
- `/api/people` CRUD
- `/api/places` CRUD
- `/api/pages` CRUD (markdown pages)
- `/api/graph` (nodes/edges, backlinks, фильтры gm/player)
- `/api/snapshots` (list/create/select)
- `/api/snapshots/{id}/territory/tiles` (download/upload изменённых тайлов)
- `/api/export` / `/api/import`

#### 9.1) Инициализация проекта
**Обязательный первый шаг**: до создания любых сущностей необходимо инициализировать проект.

**Endpoint**: `POST /api/project/init`

**Параметры** (опциональные, с разумными defaults):
- `world_name` (string, default="Doskvol") — название мира/города.
- `description` (string, optional) — описание мира.
- `timezone` (string, default="UTC") — часовой пояс для корректной работы таймлайна.
- `initial_snapshot_date` (datetime, default=фиксированная epoch-дата 1847-01-01T00:00:00Z) — дата стартового снимка.
- `initial_snapshot_label` (string, default="Initial") — метка стартового снимка.

**Поведение**:
1. Проверяет, что база пуста (нет ни одного `World`).
2. Создаёт единственный `World` с указанными параметрами.
3. Создаёт стартовый `Snapshot` с заданной датой и меткой.
4. Устанавливает созданный снимок как активный (`ActiveSnapshot`).
5. Возвращает `201 Created` с данными созданного мира и снимка.

**Защита от повторной инициализации**:
- Если в базе уже есть `World`, endpoint возвращает `409 Conflict` с сообщением "Project already initialized".

**Поведение остальных API до инициализации**:
- Все CRUD-эндпоинты (`/api/factions`, `/api/people`, `/api/places`, `/api/pages`, `/api/snapshots`, `/api/graph`) **требуют** инициализированный проект.
- Если проект не инициализирован (нет `World` в базе), эти эндпоинты возвращают `409 Conflict` с сообщением "Project not initialized. Call POST /api/project/init first".
- **Исключения** (работают без инициализации):
  - `GET /health`, `GET /` — технические эндпоинты.
  - `POST /api/import` — может восстановить проект из бэкапа.

### 10) Экспорт/импорт
Требования:
- Переносимость проекта между устройствами.
- В MVP: экспорт как файл проекта (варианты):
  - SQLite-файл проекта (предпочтительно),
  - либо zip-пакет (SQLite + assets) — если понадобится.

### 11) Нефункциональные требования
- **Производительность**: рисование не должно лагать на средних картах (ориентир: 4k), тайлинг и кэш.
- **Надёжность**: защита от порчи проекта (атомарные операции на запись снимков/тайлов).
- **Безопасность**: backend слушает только localhost; Electron и backend обмениваются токеном (в будущем).
- **Юзабилити**: быстрые hotkeys (позже), undo/redo (позже).

### 12) Критерии приёмки MVP
- Можно загрузить карту, создать ≥3 фракции и **закрасить** территории каждой полупрозрачным цветом, при этом карта остаётся видимой под заливкой.
- Можно создать персонажа и место, связать их (через поля и/или wikilinks), увидеть backlinks.
- Можно создать GM-only заметку и убедиться, что в Player-режиме она не отображается.
- Можно создать 2 снимка на разные даты, изменить территории, и при переключении снимков видеть разные состояния карты.
- Можно экспортировать проект и импортировать его в “чистую” установку, получив те же данные и слои.

### 13) Инструменты разработки (для команды)
- В репозитории используется **Shrimp Task Manager** как **MCP-сервис для Cursor** для планирования и ведения многошаговых задач.
- Конфигурация MCP-сервиса хранится в `.cursor/mcp.json`.
- Локальные данные Shrimp хранятся в `.shrimp/` и **не коммитятся** (см. `.gitignore`).
